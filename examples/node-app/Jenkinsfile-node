@Library('jenkins-shared-library@main') _

import org.agileqa.pipeline.ConfigDefaults

//int dockerGid = cfg.dockerGid ?: ConfigDefaults.DOCKER_GID as int

def proxyEnv         = [:]
def repo             = null
def tag              = ''
def projDir          = 'examples/node-app'
def buildCtx         = projDir
def dockerfile       = "${projDir}/Dockerfile"  // unambiguous path from workspace root
def npmCacheHost     = ''
def innerDockerArgs  = '' // for nested docker if you keep it



pipeline {
    agent {
        docker {
            label 'built-in' // ensure we run on Built‑In Node
            image 'agileqa/jenkins-agent:multi-tool'
            // host network (corp DNS), host docker socket, docker group GID (replace 991)
            args  '--network host -v /var/run/docker.sock:/var/run/docker.sock --group-add ${DOCKER_GID}'
            reuseNode true
        }
    }

    options {
        skipDefaultCheckout(true)
        timestamps()
        ansiColor('xterm')
    }

    parameters {
        booleanParam(name: 'USE_BUILDX',   defaultValue: false, description: 'Use docker buildx (multi-arch)')
        string(name: 'IMAGE_TAG', defaultValue: '', description: 'Optional override (defaults to "latest")')

        // Optional overrides (primary source is credentials via collectProxyEnv)
        string(name: 'HTTP_PROXY', defaultValue: '', description: '(optional) http://user:pass@proxy-host:port')
        string(name: 'NO_PROXY',   defaultValue: '', description: '(optional) localhost,127.0.0.1,.corp.local')

        // so we avoid hardcoding repo
        string(name: 'DOCKERHUB_REPO', defaultValue: 'agileqa/node-sample', description: 'Docker Hub repo (org/name)')
    }

    environment {
        DOCKER_GID = "${ConfigDefaults.DOCKER_GID}"
    }

    // No global proxy environment here—inject only where needed via withEnv(proxyEnv)

    stages {
        stage('Setup') {
            steps {
                script {
                    echo "=== Proxy Configuration Check ==="
                    
                    // Test if on VPN
                    def onVPN = sh(script: 'ping -c 1 proxy 2>/dev/null', returnStatus: true) == 0
                    
                    echo "VPN Status: ${onVPN ? 'CONNECTED' : 'DISCONNECTED'}"
                    
                    if (!onVPN) {
                        echo "Off VPN - Disabling proxy for Git"
                        env.GIT_CONFIG_PARAMETERS = "'http.proxy=' 'https.proxy='"
                    } else {
                        echo "On VPN - Using corporate proxy"
                    }
                    
                    // Log current proxy settings
                    echo "=== Environment Variables ==="
                    sh '''
                        echo "http_proxy: ${http_proxy:-not set}"
                        echo "https_proxy: ${https_proxy:-not set}"
                        echo "no_proxy: ${no_proxy:-not set}"
                        echo "GIT_CONFIG_PARAMETERS: ${GIT_CONFIG_PARAMETERS:-not set}"
                    '''
                    
                    // Log Git proxy configuration
                    echo "=== Git Proxy Configuration ==="
                    sh '''
                        echo "Git http.proxy: $(git config --get http.proxy || echo 'not set')"
                        echo "Git https.proxy: $(git config --get https.proxy || echo 'not set')"
                    '''
                    
                    // Test connectivity
                    echo "=== Connectivity Test ==="
                    sh '''
                        echo "Testing GitHub connectivity..."
                        if curl -I --connect-timeout 5 https://github.com 2>&1 | head -n 1; then
                            echo "✓ GitHub is reachable"
                        else
                            echo "✗ GitHub is NOT reachable"
                        fi
                    '''
                }
            }
        }


        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Init') {
            steps {
                script {
                    // Build proxy env once (collectProxyEnv should handle params/env/credentials precedence)
                    proxyEnv        = collectProxyEnv(proxyCredId: 'corp-proxy-url', noProxyCredId: 'corp-no-proxy')

                    // Repo & tag
                    repo            = (params.DOCKERHUB_REPO?.trim()) ? params.DOCKERHUB_REPO.trim() : 'agileqa/node-sample'
                    tag             = env.IMAGE_TAG?.trim() ? env.IMAGE_TAG.trim() : 'latest'

                    // Caches & inner docker args
                    npmCacheHost    = "${env.WORKSPACE}/.npm"
                    sh "mkdir -p '${npmCacheHost}'"
                    //innerDockerArgs = '--network host -v /var/run/docker.sock:/var/run/docker.sock --group-add ${DOCKER_GID} -v ${npmCacheHost}:/home/node/.npm'
                    
                    innerDockerArgs = "--network host -v /var/run/docker.sock:/var/run/docker.sock --group-add \$DOCKER_GID -v ${npmCacheHost}:/home/node/.npm"

                    echo "Inner docker args: ${innerDockerArgs}"
                    echo "DOCKER_GID env: ${env.DOCKER_GID}"

                    sh '''
                      set -eu
                      id
                      ls -l /var/run/docker.sock || true
                      docker version
                    '''

                    sh """
                      set -eu
                      test -f '${dockerfile}'
                      head -n 5 '${dockerfile}'
                    """
                }
            }
        }
        // stage('Security Scan') {
        //     steps {
        //         script {
        //             securityScan(
        //                 image: repo,
        //                 tag: tag,
        //                 failOnHigh: true,
        //                 checkDependencies: true
        //             )
        //         }
        //     }
        // }

        stage('Preflight') {
            steps {
                script {
                    withEnv(proxyEnv) {
                        // Prefer running “here” to avoid nested docker; set inside:true if you really want nesting
                        preflightCheck(
                            inside    : false,
                            image     : 'agileqa/jenkins-agent:multi-tool',
                            dockerArgs: innerDockerArgs,
                            workDir   : projDir
                        )
                    }
                }
            }
        }

        stage('Build (Node)') {
            steps {
                script {
                    // Ensure proxy variables are set and devDependencies are installed
                    withEnv(proxyEnv + ['NODE_ENV=development']) {
                        dir(projDir) {
                            nodeInstallBuild(
                                node:        '20-alpine',   // Node.js version (Docker tag)
                                pkgMgr:      'npm',         // or 'yarn' if preferred
                                buildScript: 'build'        // script name in package.json
                            )
                        }
                    }
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // Detect VPN by resolving your corp proxy/DNS host (adjust 'proxy' if needed)
                    // Using 'getent hosts' is fast and less noisy than ping; fallback to ping if not available.
                    int vpnStatus = sh(
                        script: 'getent hosts proxy >/dev/null 2>&1 || ping -c 1 -W 1 proxy >/dev/null 2>&1',
                        returnStatus: true
                    )
                    boolean onVPN = (vpnStatus == 0)

                    echo "=== Docker Build Stage ==="
                    echo "VPN Status: ${onVPN ? 'CONNECTED' : 'DISCONNECTED'}"

                    // Ensure proxyEnv is a List<String> like ["HTTP_PROXY=http://...","NO_PROXY=..."]
                    List<String> proxyEnvList = (proxyEnv instanceof List) ? proxyEnv : []

                    if (onVPN) {
                        echo "On VPN - Using proxy for Docker operations"
                        withEnv(proxyEnvList + ["DOCKER_BUILDKIT=${params.USE_BUILDKIT ? '1' : '0'}"]) {
                            sh '''#!/bin/sh
                                set -eu
                                echo "Pulling with proxy settings..."
                                docker pull node:20-alpine || true
                            '''
                            dockerBuildPush(
                                image        : repo,
                                tag          : tag,
                                dockerfile   : dockerfile,
                                context      : buildCtx,
                                useBuildx    : false,
                                useBuildKit  : params.USE_BUILDKIT,
                                proxyEnv     : proxyEnvList,         // pass through
                                allowHostNetwork: true,              // keep if you rely on host DNS
                                credentialsId: 'docker-hub-agileqa'
                            )
                        }
                    } else {
                        echo "Off VPN - Pulling without proxy"
                        withEnv(["DOCKER_BUILDKIT=${params.USE_BUILDKIT ? '1' : '0'}"]) {
                            sh '''#!/bin/sh
                                set -eu
                                # Explicitly unset all proxy variables for Docker operations
                                unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY no_proxy NO_PROXY
                                echo "Pulling without proxy..."
                                docker pull node:20-alpine || true
                            '''
                            dockerBuildPush(
                                image        : repo,
                                tag          : tag,
                                dockerfile   : dockerfile,
                                context      : buildCtx,
                                useBuildx    : false,
                                useBuildKit  : params.USE_BUILDKIT,
                                proxyEnv     : [],                    // empty list = no proxy inside step
                                allowHostNetwork: true,
                                credentialsId: 'docker-hub-agileqa'
                            )
                        }
                    }
                }
            }
        }

        stage('Deploy Locally') {
            steps {
                script {
                    deployContainer(image: "${repo}:${tag}", containerName: 'node_sample_container')
                }
            }
        }
    }

    post {
        always {
            echo "Build finished for ${repo}:${tag}"
        }
    }
}