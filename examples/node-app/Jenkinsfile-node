@Library('jenkins-shared-library@main') _

def proxyEnv       = [:]
def repo           = 'agileqa/node-sample'
def tag            = ''
def projDir        = 'examples/node-app'
def dockerfile     = ''
def buildCtx       = '.'
def npmCacheHost   = ''
def innerDockerArgs = ''  // used by preflightCheck's inside()

pipeline {
    agent {
        docker {
            image 'agileqa/jenkins-agent:multi-tool'
            // IMPORTANT:
            //  - Keep docker socket mount
            //  - Add a public DNS fallback to avoid ENOTFOUND if you temporarily run without proxy
            //  - Adjust --group-add GID to your host docker group
            args  '-v /var/run/docker.sock:/var/run/docker.sock --group-add 991 --dns 8.8.8.8 --dns 1.1.1.1'
            reuseNode true
        }
    }

    options {
        skipDefaultCheckout(true)
        timestamps()
        ansiColor('xterm')
    }

    // --- NEW: Parameters so you can feed proxies without editing the file ---
    parameters {
        booleanParam(name: 'USE_BUILDKIT', defaultValue: true,  description: 'Enable Docker BuildKit')
        booleanParam(name: 'USE_BUILDX',   defaultValue: false, description: 'Use docker buildx (multi-arch)')
        string(name: 'IMAGE_TAG',  defaultValue: '', description: 'Optional override for image tag (defaults to "latest")')
        string(name: 'HTTP_PROXY', defaultValue: '', description: 'e.g. http://user:pass@host:port')
        string(name: 'HTTPS_PROXY', defaultValue: '', description: 'e.g. http://user:pass@host:port')
        string(name: 'NO_PROXY',   defaultValue: '', description: 'e.g. .corp.local,localhost,127.0.0.1')
    }

    // --- NEW: Ensure these env vars exist INSIDE the agent container ---
    environment {
        DOCKERHUB_REPO = 'agileqa/node-sample'
        // If you set Jenkins global env vars (Manage Jenkins → System → Global properties),
        // they will populate these automatically. Otherwise, use the parameters above.
        HTTP_PROXY  = "${params.HTTP_PROXY ?: env.HTTP_PROXY ?: ''}"
        HTTPS_PROXY = "${params.HTTPS_PROXY ?: env.HTTPS_PROXY ?: ''}"
        NO_PROXY    = "${params.NO_PROXY ?: env.NO_PROXY ?: ''}"
        // Lowercase variants for tools that expect them:
        http_proxy  = "${HTTP_PROXY}"
        https_proxy = "${HTTPS_PROXY}"
        no_proxy    = "${NO_PROXY}"
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Init') {
            steps {
                script {
                    // Your shared helper may read env.*; keep using it in case you centralize proxy logic there.
                    proxyEnv   = collectProxyEnv()
                    tag        = env.IMAGE_TAG?.trim() ? env.IMAGE_TAG.trim() : 'latest'
                    dockerfile = "${projDir}/Dockerfile"

                    npmCacheHost = "${env.WORKSPACE}/.npm"
                    sh "mkdir -p '${npmCacheHost}'"

                    // Preflight runs inside another container too; give it the socket & npm cache
                    innerDockerArgs = "-v /var/run/docker.sock:/var/run/docker.sock --group-add 991 -v ${npmCacheHost}:/home/node/.npm --dns 8.8.8.8 --dns 1.1.1.1"
                }
            }
        }

        stage('Preflight') {
            steps {
                script {
                    // Make preflight curl checks proxy-aware
                    withEnv(proxyEnv) {
                        preflightCheck(
                            image: 'agileqa/jenkins-agent:multi-tool',
                            dockerArgs: innerDockerArgs,
                            workDir: projDir
                        )
                    }
                }
            }
        }

        stage('Build (Node)') {
            steps {
                script {
                    // Use proxy env; but force NO_PROXY empty here so npm doesn’t bypass proxy
                    withEnv(proxyEnv + ['NO_PROXY=', 'no_proxy=']) {
                        dir(projDir) {
                            sh '''
                              set -eux
                              echo "== proxies in env =="
                              env | grep -i proxy || true

                              # Configure npm to use proxy explicitly if provided
                              if [ -n "${HTTP_PROXY:-}" ]; then npm config set proxy "$HTTP_PROXY"; fi
                              if [ -n "${HTTPS_PROXY:-}" ]; then npm config set https-proxy "$HTTPS_PROXY"; fi
                              npm config delete noproxy || true
                              npm config set noproxy "" || true

                              echo "== npm config =="
                              npm config get proxy || true
                              npm config get https-proxy || true
                              npm config get noproxy || true

                              echo "== quick net checks =="
                              node --version
                              npm --version
                              (command -v curl >/dev/null 2>&1 && curl -I --max-time 10 https://registry.npmjs.org) || true
                            '''
                            // shared lib: `npm install && npm run build`
                           sh ''' env | grep -i proxy || true
npm config list
getent hosts registry.npmjs.org || true
curl -I --max-time 10 https://registry.npmjs.org || true '''
                            runBuild('node')
                        }
                    }
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // dockerBuildPush already supports proxyEnv and BuildKit/Buildx toggles
                    dockerBuildPush(
                        image       : repo,
                        tag         : tag,
                        dockerfile  : dockerfile,
                        context     : buildCtx,
                        useBuildx   : params.USE_BUILDX,
                        useBuildKit : params.USE_BUILDKIT,
                        proxyEnv    : proxyEnv
                    )
                }
            }
        }

        stage('Deploy Locally') {
            steps {
                script {
                    // Assumes the Node image listens on port 80 and exposes /health
                    deployContainer(image: "${repo}:${tag}", containerName: 'node_sample_container')
                }
            }
        }
    }

    post {
        always {
            echo "Build finished for ${repo}:${tag}"
        }
    }
}