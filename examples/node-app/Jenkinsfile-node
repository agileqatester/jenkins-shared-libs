@Library('jenkins-shared-library@main') _

/**
 * Node.js pipeline using the multi-tool agent for ALL stages.
 * Image: agileqa/jenkins-agent:multi-tool (must include docker, node, npm)
 * App repo & paths:
 *   - Image repo: agileqa/node-sample
 *   - Workdir   : examples/node-app
 *   - Dockerfile: examples/node-app/Dockerfile
 */

def proxyEnv     = [:]
def repo         = 'agileqa/node-sample'
def tag          = ''
def projDir      = 'examples/node-app'
def dockerfile   = ''
def buildCtx     = '.'
def npmCacheHost = ''
def innerDockerArgs = ''  // for preflightCheck's inside() mount

pipeline {
    agent {
        docker {
            image 'agileqa/jenkins-agent:multi-tool'
            // IMPORTANT: adjust the GID below to match host docker group (run `getent group docker`)
            args  '-v /var/run/docker.sock:/var/run/docker.sock --group-add 991'
            reuseNode true
        }
    }

    options {
        skipDefaultCheckout(true)
        timestamps()
        ansiColor('xterm')
    }

    parameters {
        booleanParam(name: 'USE_BUILDKIT', defaultValue: true,  description: 'Enable Docker BuildKit')
        booleanParam(name: 'USE_BUILDX',   defaultValue: false, description: 'Use docker buildx (multi-arch)')
        string(name: 'IMAGE_TAG', defaultValue: '', description: 'Optional override for image tag (defaults to "latest")')
    }

    environment {
        DOCKERHUB_REPO = 'agileqa/node-sample'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Init') {
            steps {
                script {
                    proxyEnv   = collectProxyEnv()
                    tag        = env.IMAGE_TAG?.trim() ? env.IMAGE_TAG.trim() : 'latest'
                    dockerfile = "${projDir}/Dockerfile"

                    // Local npm cache and socket mount for inner container used by preflightCheck
                    npmCacheHost = "${env.WORKSPACE}/.npm"
                    sh "mkdir -p '${npmCacheHost}'"

                    // Preflight runs inside another container too; give it the socket & npm cache
                    // Adjust docker group GID if different on your host
                    innerDockerArgs = "-v /var/run/docker.sock:/var/run/docker.sock --group-add 991 -v ${npmCacheHost}:/home/node/.npm"
                }
            }
        }

        stage('Preflight') {
            steps {
                script {
                    // Use the same multi-tool image for preflight to ensure docker CLI is available inside()
                    preflightCheck(image: 'agileqa/jenkins-agent:multi-tool', dockerArgs: innerDockerArgs, workDir: projDir)
                }
            }
        }

stage('Build (Node)') {
    steps {
        script {
            // Apply proxy env but explicitly clear NO_PROXY to avoid bypassing the proxy for npmjs.org
            withEnv(proxyEnv + ['NO_PROXY=', 'no_proxy=']) {
                dir(projDir) {
                    sh '''
                      set -eux
                      # Configure npm to use the proxy if provided
                      if [ -n "${HTTP_PROXY:-}" ]; then npm config set proxy "$HTTP_PROXY"; fi
                      if [ -n "${HTTPS_PROXY:-}" ]; then npm config set https-proxy "$HTTPS_PROXY"; fi

                      # Ensure npm doesn't bypass the proxy
                      npm config delete noproxy || true
                      npm config set noproxy "" || true

                      echo "== npm proxy config =="
                      npm config get proxy || true
                      npm config get https-proxy || true
                      npm config get noproxy || true

                      echo "== quick connectivity checks =="
                      node --version
                      npm --version
                      # This uses proxy if env is set; it's OK if it fails, just for visibility
                      (command -v curl >/dev/null 2>&1 && curl -I --max-time 15 https://registry.npmjs.org) || true
                    '''
                    // Shared lib: runs `npm install && npm run build`
                    sh '''
                    echo "== Env proxies =="
                    env | grep -i proxy || true

                    echo "== DNS test (should succeed or go via proxy) =="
                    getent hosts registry.npmjs.org || nslookup registry.npmjs.org || dig +short registry.npmjs.org || true

                    echo "== npm ping (uses npm config) =="
                    npm ping || true

                    echo "== npm config list =="
                    npm config list
                    '''
                    runBuild('node')
                }
            }
        }
    }
}

        stage('Docker Build & Push') {
            steps {
                script {
                    dockerBuildPush(
                        image       : repo,
                        tag         : tag,
                        dockerfile  : dockerfile,
                        context     : buildCtx,
                        useBuildx   : params.USE_BUILDX,
                        useBuildKit : params.USE_BUILDKIT,
                        proxyEnv    : proxyEnv
                        // secretFiles: ['.npmrc'] // enable if you add a private registry token
                    )
                }
            }
        }

        stage('Deploy Locally') {
            steps {
                script {
                    // Your helper expects the app to expose port 80 and a /health endpoint.
                    // If your Node app uses 3000, I can extend deployContainer to accept ports.
                    deployContainer(image: "${repo}:${tag}", containerName: 'node_sample_container')
                }
            }
        }
    }

    post {
        always {
            echo "Build finished for ${repo}:${tag}"
        }
    }
}
