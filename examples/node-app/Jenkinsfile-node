@Library('jenkins-shared-library@main') _

def proxyEnv         = [:]
def repo             = null
def tag              = ''
def projDir          = 'examples/node-app'
def buildCtx         = projDir
def dockerfile       = "${projDir}/Dockerfile"  // unambiguous path from workspace root
def npmCacheHost     = ''
def innerDockerArgs  = '' // for nested docker if you keep it

pipeline {
    agent {
        docker {
            label 'built-in' // ensure we run on Built‑In Node
            image 'agileqa/jenkins-agent:multi-tool'
            // host network (corp DNS), host docker socket, docker group GID (replace 991)
            args  '--network host -v /var/run/docker.sock:/var/run/docker.sock --group-add 991'
            reuseNode true
        }
    }

    options {
        skipDefaultCheckout(true)
        timestamps()
        ansiColor('xterm')
    }

    parameters {
        booleanParam(name: 'USE_BUILDKIT', defaultValue: true,  description: 'Enable Docker BuildKit')
        booleanParam(name: 'USE_BUILDX',   defaultValue: false, description: 'Use docker buildx (multi-arch)')
        string(name: 'IMAGE_TAG', defaultValue: '', description: 'Optional override (defaults to "latest")')

        // Optional overrides (primary source is credentials via collectProxyEnv)
        string(name: 'HTTP_PROXY', defaultValue: '', description: '(optional) http://user:pass@proxy-host:port')
        string(name: 'NO_PROXY',   defaultValue: '', description: '(optional) localhost,127.0.0.1,.corp.local')

        // so we avoid hardcoding repo
        string(name: 'DOCKERHUB_REPO', defaultValue: 'agileqa/node-sample', description: 'Docker Hub repo (org/name)')
    }

    // No global proxy environment here—inject only where needed via withEnv(proxyEnv)

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Init') {
            steps {
                script {
                    // Build proxy env once (collectProxyEnv should handle params/env/credentials precedence)
                    proxyEnv        = collectProxyEnv(proxyCredId: 'corp-proxy-url', noProxyCredId: 'corp-no-proxy')

                    // Repo & tag
                    repo            = (params.DOCKERHUB_REPO?.trim()) ? params.DOCKERHUB_REPO.trim() : 'agileqa/node-sample'
                    tag             = env.IMAGE_TAG?.trim() ? env.IMAGE_TAG.trim() : 'latest'

                    // Caches & inner docker args
                    npmCacheHost    = "${env.WORKSPACE}/.npm"
                    sh "mkdir -p '${npmCacheHost}'"
                    innerDockerArgs = "--network host -v /var/run/docker.sock:/var/run/docker.sock --group-add 991 -v ${npmCacheHost}:/home/node/.npm"

                    sh '''
                      set -eu
                      id
                      ls -l /var/run/docker.sock || true
                      docker version
                    '''

                    sh """
                      set -eu
                      test -f '${dockerfile}'
                      head -n 5 '${dockerfile}'
                    """
                }
            }
        }

        stage('Preflight') {
            steps {
                script {
                    withEnv(proxyEnv) {
                        // Prefer running “here” to avoid nested docker; set inside:true if you really want nesting
                        preflightCheck(
                            inside    : false,
                            image     : 'agileqa/jenkins-agent:multi-tool',
                            dockerArgs: innerDockerArgs,
                            workDir   : projDir
                        )
                    }
                }
            }
        }

        stage('Build (Node)') {
            steps {
                script {
                    withEnv(proxyEnv) {
                        dir(projDir) {
                            // Prefer using your shared lib’s runBuild('node') to keep behavior centralized:
                            runBuild('node')
                            // Or explicit commands instead of runBuild:
                            // sh '''
                            //   set -eu
                            //   npm ci --no-audit --no-fund
                            //   npm run build
                            // '''
                        }
                    }
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // Provide proxy vars during docker build (as build-args, not ENV in Dockerfile)
                    withEnv(proxyEnv) {
                        sh '''#!/bin/sh
                        set -eu
                        # Pre-pull base image using the daemon path (may hit host DNS/proxy)
                        docker pull node:20-alpine || true
                        '''
                        dockerBuildPush(
                            image       : repo,
                            tag         : tag,
                            dockerfile  : dockerfile, // examples/node-app/Dockerfile
                            context     : buildCtx,   // examples/node-app
                            useBuildx   : false,
                            useBuildKit : params.USE_BUILDKIT,
                            proxyEnv    : proxyEnv
                        )
                    }
                }
            }
        }

        stage('Deploy Locally') {
            steps {
                script {
                    deployContainer(image: "${repo}:${tag}", containerName: 'node_sample_container')
                }
            }
        }
    }

    post {
        always {
            echo "Build finished for ${repo}:${tag}"
        }
    }
}