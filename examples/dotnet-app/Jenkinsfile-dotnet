@Library('jenkins-shared-library@main') _
node {
    properties([parameters([
        booleanParam(name: 'USE_BUILDKIT', defaultValue: true),
        booleanParam(name: 'USE_BUILDX', defaultValue: false)
    ])])

    def buildImage    = selectAgent('dotnet')
    def repo          = 'agileqa/dotnet-sample'
    def tag           = env.IMAGE_TAG ?: 'latest'
    def projDir       = 'examples/dotnet-app'
    def dockerfile    = "${projDir}/Dockerfile"
    def buildCtx      = '.'
    def nugetHomeHost = "${env.WORKSPACE}/.nuget"
    def dockerArgs    = nugetDockerArgs(nugetHomeHost: nugetHomeHost)
    def proxyEnv      = collectProxyEnv()

    stage('Checkout') { checkout scm }
    stage('Preflight') { preflightCheck(image: buildImage, dockerArgs: dockerArgs, workDir: projDir) }
    stage('NuGet Prep') { dotnetNugetPrep(image: buildImage, dockerArgs: dockerArgs, nugetHomeHost: nugetHomeHost) }
    stage('Prepare NuGet Config') { prepareNugetConfig() }
    stage('Build (.NET)') { dotnetBuild(image: buildImage, dockerArgs: dockerArgs, envVars: proxyEnv, workDir: projDir) }
    stage('Docker Build & Push') {
        dockerBuildPush(image: repo, tag: tag, dockerfile: dockerfile, context: buildCtx,
                        useBuildx: params.USE_BUILDX, useBuildKit: params.USE_BUILDKIT,
                        proxyEnv: proxyEnv, secretFiles: ['nuget.config'])
    }
    stage('Deploy Locally') { deployContainer(image: "${repo}:${tag}") }
}
