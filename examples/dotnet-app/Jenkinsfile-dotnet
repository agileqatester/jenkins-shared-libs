@Library('jenkins-shared-library@main') _
node {
    properties([parameters([
        booleanParam(name: 'USE_BUILDKIT', defaultValue: true),
        booleanParam(name: 'USE_BUILDX', defaultValue: false)
    ])])

    def buildImage = selectAgent('dotnet')
    def nugetHomeHost = "${env.WORKSPACE}/.nuget"
    def dockerArgs = nugetDockerArgs(nugetHomeHost: nugetHomeHost)

    stage('Checkout') { checkoutRepo() }
    stage('NuGet Prep') {
        dotnetNugetPrep(image: buildImage, dockerArgs: dockerArgs, nugetHomeHost: nugetHomeHost)
    }
    stage('Build (.NET)') {
        dotnetBuild(image: buildImage, dockerArgs: dockerArgs)
    }
    stage('Docker Build & Push') {
        dockerBuildPush(
            image: 'agileqa/dotnet-sample',
            tag: env.IMAGE_TAG ?: 'latest',
            dockerfile: 'examples/dotnet-app/Dockerfile',
            context: '.',
            useBuildx: params.USE_BUILDX,
            useBuildKit: params.USE_BUILDKIT,
            proxyEnv: collectProxyEnv(),
            secretFiles: ['nuget.config']
        )
    }
}