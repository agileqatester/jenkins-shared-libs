node {
    // === Image + App configuration ===
    def buildImage = 'agileqa/jenkins-agent:multi-tool'        // your toolbox image
    def repo       = 'agileqa/dotnet-sample'                   // Docker Hub app repo
    def tag        = env.IMAGE_TAG ?: 'latest'                 // image tag

    // .NET app layout in this repo
    def projDir    = 'examples/dotnet-app'                     // contains DotnetApp.csproj
    def dockerfile = 'examples/dotnet-app/Dockerfile'          // app Dockerfile
    def buildCtx   = '.'                                       // keep root context

    // Host-side NuGet HOME under workspace (will be mounted later)
    def nugetHomeHost = "${env.WORKSPACE}/.nuget"
    sh "mkdir -p '${nugetHomeHost}/packages' '${nugetHomeHost}/NuGet' || true"

    // Will be computed AFTER loading the shared library
    def dockerArgs = null

    // Standard .NET CI env
    def dotnetEnv = [
        "HOME=/home/jenkins",
        "DOTNET_CLI_HOME=/home/jenkins",
        "DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1",
        "DOTNET_CLI_TELEMETRY_OPTOUT=1",
        "NUGET_PACKAGES=/home/jenkins/.nuget/packages"
    ]

    // --- Proxy propagation: gather from controller env ---
    def proxyEnv = []
    if (env.http_proxy)  proxyEnv << "http_proxy=${env.http_proxy}"
    if (env.https_proxy) proxyEnv << "https_proxy=${env.https_proxy}"
    if (env.no_proxy)    proxyEnv << "no_proxy=${env.no_proxy}"
    if (env.HTTP_PROXY)  proxyEnv << "HTTP_PROXY=${env.HTTP_PROXY}"
    if (env.HTTPS_PROXY) proxyEnv << "HTTPS_PROXY=${env.HTTPS_PROXY}"
    if (env.NO_PROXY)    proxyEnv << "NO_PROXY=${env.NO_PROXY}"

    timestamps {
        try {
            stage('Checkout') {
                checkout scm
                sh 'git rev-parse --short HEAD || true'
            }

            stage('Load Shared Library') {
                // If your lib is public, you can omit credentialsId
                library identifier: 'jenkins-shared-library@main', retriever: modernSCM([
                    $class: 'GitSCMSource',
                    remote: 'https://github.com/agileqatester/jenkins-shared-libs.git',
                    credentialsId: 'git-agiletester'
                ])
                echo 'Shared library loaded.'
            }

            stage('Init Agent & Compose dockerArgs') {
                echo "Using build image: ${buildImage}"

                // Compute dockerArgs *after* the library is loaded
                script {
                    // dockerGid must match your host’s /var/run/docker.sock group (you verified it’s 991)
                    def dockerArgsBase = nugetDockerArgs(
                        nugetHomeHost: nugetHomeHost,
                        nugetHomeContainer: '/home/jenkins/.nuget',
                        dockerGid: 991
                    )

                    // Extend with -e flags for proxy passthrough into the inner container
                    dockerArgs = dockerArgsBase +
                        (env.http_proxy  ? " -e http_proxy=${env.http_proxy}"     : "") +
                        (env.https_proxy ? " -e https_proxy=${env.https_proxy}"   : "") +
                        (env.no_proxy    ? " -e no_proxy=${env.no_proxy}"         : "") +
                        (env.HTTP_PROXY  ? " -e HTTP_PROXY=${env.HTTP_PROXY}"     : "") +
                        (env.HTTPS_PROXY ? " -e HTTPS_PROXY=${env.HTTPS_PROXY}"   : "") +
                        (env.NO_PROXY    ? " -e NO_PROXY=${env.NO_PROXY}"         : "")
                }
                echo "dockerArgs composed."
            }

            // Prepare NuGet mount permissions using your shared step (now available)
            stage('NuGet Prep') {
                dotnetNugetPrep(
                    image: buildImage,
                    dockerArgs: dockerArgs,                          // includes socket, group, nuget mount, and proxies
                    nugetHomeHost: nugetHomeHost,
                    nugetHomeContainer: '/home/jenkins/.nuget',
                    uid: 1000,
                    gid: 1000
                )
            }

            stage('Preflight') {
                withEnv(dotnetEnv + proxyEnv) {
                    docker.image(buildImage).inside(dockerArgs) {
                        sh """
                          set -eux
                          echo '=== Preflight ==='
                          whoami; id
                          echo HOME=\$HOME
                          env | egrep -i 'http_proxy|https_proxy|no_proxy' || true

                          # Verify Docker client/server
                          which docker
                          docker version

                          # Quick network probe to NuGet (via proxy if present)
                          curl -I --max-time 20 https://api.nuget.org/v3/index.json

                          # .NET SDK checks (net7 warning is okay)
                          dotnet --info || true
                          dotnet --list-sdks || true

                          echo '== Workspace =='; pwd
                          echo '== Top-level =='; ls -la
                          echo '== Project dir =='; ls -la ${projDir}
                          test -d ${projDir}
                          test -f ${dockerfile}

                          # Confirm we can write into NuGet config dir
                          touch /home/jenkins/.nuget/NuGet/.writetest && rm /home/jenkins/.nuget/NuGet/.writetest
                          echo '=== Preflight OK ==='
                        """
                    }
                }
            }

            stage('Build (.NET)') {
                withEnv(dotnetEnv + proxyEnv) {
                    docker.image(buildImage).inside(dockerArgs) {
                        dir(projDir) {
                            sh '''
                              set -eux
                              dotnet restore
                              dotnet build --configuration Release
                            '''
                        }
                    }
                }
            }

            stage('Docker Build & Push (App)') {
                withEnv(dotnetEnv + proxyEnv + ["DOCKER_BUILDKIT=1"]) {
                    docker.image(buildImage).inside(dockerArgs) {
                        docker.withRegistry('https://index.docker.io/v1/', 'docker-hub-agileqa') {
                            def app = docker.build("${repo}:${tag}", "-f ${dockerfile} ${buildCtx}")
                            app.push()
                            if (tag != 'latest') {
                                sh "set -eux; docker tag ${repo}:${tag} ${repo}:latest; docker push ${repo}:latest"
                            }
                        }
                    }
                }
            }

            stage('Deploy Locally') {
                docker.image(buildImage).inside(dockerArgs) {
                    sh """
                      set -eux
                      docker rm -f dotnet_sample_container || true
                      # If app is console-only, remove the -p mapping; if ASP.NET on port 80, keep it:
                      docker run -d --name dotnet_sample_container -p 8080:80 "${repo}:${tag}"
                    """
                }
            }
        } catch (err) {
            currentBuild.result = 'FAILURE'
            echo "Pipeline failed: ${err}"
            throw err
        } finally {
            stage('Cleanup') {
                docker.image(buildImage).inside(dockerArgs ?: '') {
                    sh 'set -eux; docker image ls | head -n 20 || true'
                }
            }
        }
    }
}