def repo       = 'agileqa/dotnet-sample'
def tag        = env.IMAGE_TAG ?: 'latest'
def buildCtx   = 'examples/dotnet-app'
def dockerArgs = '-v /var/run/docker.sock:/var/run/docker.sock -v $HOME/.nuget/packages:/root/.nuget/packages'

def buildImage = selectAgent('dotnet') // returns something like 'mcr.microsoft.com/dotnet/sdk:7.0'

timestamps {
    docker.image(buildImage).inside(dockerArgs) {
        try {
            stage('Checkout') {
                checkout scm
            }

            stage('Load Shared Library') {
                library identifier: 'jenkins-shared-library@main', retriever: modernSCM([
                    $class: 'GitSCMSource',
                    remote: 'https://github.com/agileqatester/jenkins-shared-libs.git',
                    credentialsId: 'git-agiletester'
                ])
                echo 'Shared library loaded.'
            }

            stage('Build (.NET)') {
                dir(buildCtx) {
                    runBuild('dotnet') // assumes this runs dotnet restore/build/test
                }
            }

            stage('Docker Build & Push') {
                docker.withRegistry('https://index.docker.io/v1/', 'docker-hub-agileqa') {
                    def app = docker.build("${repo}:${tag}", buildCtx)
                    app.push()
                    if (tag != 'latest') {
                        sh "docker tag ${repo}:${tag} ${repo}:latest"
                        sh "docker push ${repo}:latest"
                    }
                }
            }

            stage('Deploy Locally') {
                sh """
                    docker rm -f dotnet_sample_container || true
                    docker run -d --name dotnet_sample_container -p 8080:80 ${repo}:${tag}
                """
            }
        } catch (err) {
            currentBuild.result = 'FAILURE'
            echo "Pipeline failed: ${err}"
            throw err
        } finally {
            stage('Cleanup') {
                sh 'docker image ls | head -n 20 || true'
            }
        }
    }
}